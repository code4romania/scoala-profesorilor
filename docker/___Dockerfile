FROM php:7.2-fpm
 
# Install system dependencies
RUN apt-get update && \
    apt-get install -y nginx cron git-core jq unzip vim zip libjpeg-dev libpng-dev libpq-dev libsqlite3-dev libwebp-dev libzip-dev libxml2-dev

# Clear cache
RUN apt-get -y autoremove && \
    apt-get clean && \
    rm -rf /var/lib/apt/lists/* /tmp/* /var/tmp/*

# Install PHP extensions
RUN docker-php-ext-configure zip --with-libzip && \
    docker-php-ext-configure gd --with-png-dir --with-jpeg-dir --with-webp-dir && \
    docker-php-ext-install exif gd mysqli opcache pdo_pgsql pdo_mysql zip

# Get latest Composer
COPY --from=composer:latest /usr/bin/composer /usr/bin/composer

# Add octobercms cron
RUN echo "* * * * * /var/www/artisan schedule:run >> /dev/null 2>&1" > /etc/cron.d/october-cron && \
    crontab /etc/cron.d/october-cron

# Symlinking Nginx log files to stdout and stderr
RUN ln -sf /dev/stdout /var/log/nginx/access.log \
    && ln -sf /dev/stderr /var/log/nginx/error.log

# Set working directory
WORKDIR /var/www

COPY ./bootstrap bootstrap
COPY ./config config
COPY ./modules modules
COPY ./plugins plugins
COPY ./storage storage
COPY ./tests tests
COPY ./themes themes
COPY ./.babelrc .babelrc
COPY ./.htaccess .htaccess
COPY ./.jshintrc .jshintrc
COPY ./artisan artisan
COPY ./composer.json composer.json
COPY ./package.json package.json
COPY ./phpcs.xml phpcs.xml
COPY ./phpunit.xml phpunit.xml
COPY ./server.php server.php
COPY ./index.php index.php
# Copy nginx configuration
COPY ./docker/app.conf /etc/nginx/conf.d/default.conf
COPY ./docker/app.conf /etc/nginx/sites-available/default

#Install project dependencies
RUN composer install --no-interaction --no-dev --prefer-dist --no-scripts && \
    composer clearcache && \
    chown -R www-data:www-data /var/www && \
    find . -type d \( -path './plugins' -or  -path './storage' -or  -path './themes' -or  -path './plugins/*' -or  -path './storage/*' -or  -path './themes/*' \) -exec chmod g+ws {} \;

#Update DB schema
# ENTRYPOINT cd /var/www && php artisan october:up

EXPOSE 443 80

CMD ["nginx", "-g", "daemon off;"]
